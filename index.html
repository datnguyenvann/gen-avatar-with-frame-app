<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gh√©p khung avatar</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 300;
    }
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .right-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      border: 1px solid #e9ecef;
    }
    .section h3 {
      margin: 0 0 20px 0;
      font-size: 1.3rem;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    canvas { 
      border: 3px solid #dee2e6; 
      border-radius: 15px;
      cursor: grab; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      touch-action: none; /* Prevent scrolling when touching canvas */
    }
    canvas:active { cursor: grabbing; }
    .frame-gallery { 
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .frame-option { 
      width: 80px; 
      height: 80px; 
      border: 3px solid #dee2e6; 
      cursor: pointer; 
      border-radius: 12px;
      transition: all 0.3s ease;
      justify-self: center;
    }
    .frame-option:hover { 
      border-color: #667eea; 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .frame-option.selected { 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      transform: scale(1.05);
    }
    .upload-section {
      text-align: center;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .file-button:hover {
      transform: translateY(-2px);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #dee2e6;
      outline: none;
      appearance: none;
    }
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }
    .value-display {
      min-width: 60px;
      text-align: center;
      font-weight: 600;
      color: #667eea;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .help-text {
      background: #e3f2fd;
      color: #1976d2;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      border-left: 4px solid #2196f3;
    }
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .container {
        border-radius: 15px;
      }
      .header {
        padding: 20px 15px;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .main-content {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 20px 15px;
      }
      .left-panel {
        gap: 15px;
      }
      .right-panel {
        gap: 15px;
      }
      .section {
        padding: 15px 10px;
      }
      .section h3 {
        font-size: 1rem;
        margin: 0 0 15px 0;
      }
      canvas {
        width: 100%;
        max-width: 280px;
        height: auto;
      }
      .control-row {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }
      .slider {
        width: 100%;
        min-height: 40px;
      }
      .value-display {
        text-align: center;
        min-width: auto;
        font-size: 14px;
      }
      .button-group {
        flex-direction: column;
        gap: 8px;
      }
      .btn {
        width: 100%;
        justify-content: center;
        padding: 12px 15px;
        font-size: 14px;
      }
      .file-button {
        padding: 12px 15px;
        font-size: 14px;
      }
      .help-text {
        font-size: 12px;
        padding: 12px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      .main-content {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 15px 10px;
      }
      .left-panel {
        order: 2;
      }
      .right-panel {
        order: 1;
      }
      .section {
        padding: 12px 8px;
      }
      canvas {
        max-width: 250px;
      }
      .header h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé® Gh√©p khung avatar</h1>
    </div>
    
    <div class="main-content">
      <!-- Left Panel - Controls -->
      <div class="left-panel">
        <!-- Upload Avatar Section -->
        <div class="section upload-section">
          <h3>üì∏ Ch·ªçn ·∫£nh avatar</h3>
          <div class="file-input-wrapper">
            <input type="file" id="upload" class="file-input" accept="image/*">
            <button class="file-button">
              <span>üìÅ</span>
              <span>T·∫£i ·∫£nh l√™n</span>
            </button>
          </div>
        </div>

        <!-- Controls Section -->
        <div class="section">
          <h3>üéõÔ∏è ƒêi·ªÅu ch·ªânh ·∫£nh</h3>
          <div class="controls">
            <div class="control-group">
              <label>ÔøΩÔ∏è Khung</label>
              <button onclick="toggleFrame()" class="btn btn-secondary" id="frameToggle">
                <span>üëÅÔ∏è</span>
                <span>T·∫Øt khung</span>
              </button>
            </div>
            
            <div class="control-group">
              <label>ÔøΩüîç K√≠ch th∆∞·ªõc</label>
              <div class="control-row">
                <input type="range" id="scaleSlider" class="slider" min="0.5" max="3" step="0.1" value="1">
                <span id="scaleValue" class="value-display">100%</span>
              </div>
            </div>
            
            <div class="control-group">
              <label>‚ÜîÔ∏è Xoay</label>
              <div class="control-row">
                <input type="range" id="rotationSlider" class="slider" min="-180" max="180" step="5" value="0">
                <span id="rotationValue" class="value-display">0¬∞</span>
              </div>
            </div>
            
            <button onclick="resetTransform()" class="btn btn-secondary">
              <span>üîÑ</span>
              <span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Right Panel - Canvas and Actions -->
      <div class="right-panel">
        <canvas id="canvas" width="500" height="500"></canvas>
        
        <div class="help-text">
          üí° K√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn, d√πng thanh tr∆∞·ª£t ƒë·ªÉ thay ƒë·ªïi k√≠ch th∆∞·ªõc v√† xoay
        </div>
        
        <div class="button-group">
          <button onclick="downloadImage()" class="btn btn-primary">
            <span>‚¨áÔ∏è</span>
            <span>T·∫£i ·∫£nh k·∫øt qu·∫£</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let userImg = new Image();
    let frameImg = new Image();
    let userImgLoaded = false;
    let frameImgLoaded = false;
    
    // Set crossOrigin to avoid tainted canvas issues
    userImg.crossOrigin = "anonymous";
    frameImg.crossOrigin = "anonymous";

    // Transform properties
    let imgScale = 1;
    let imgRotation = 0;
    let imgX = 0;
    let imgY = 0;
    let isDragging = false;
    let lastMouseX = 0;
    let lastMouseY = 0;

    // C√°c khung c·ªë ƒë·ªãnh - s·ª≠ d·ª•ng SVG inline ƒë·ªÉ tr√°nh CORS
    const FRAME_DESIGNS = {
      gradient: `
        <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 501 501">
          <defs>
            <style>
              .cls-1 {
                fill: #f7941d;
                stroke: #231f20;
                stroke-miterlimit: 10;
              }
            </style>
          </defs>
          <path class="cls-1" d="m.5.5v500h500V.5H.5Zm250,433.83c-97.58,0-176.68-79.1-176.68-176.68S152.92,80.97,250.5,80.97s176.68,79.1,176.68,176.68-79.1,176.68-176.68,176.68Z"/>
        </svg>
      `,
      
      simple: `
        <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
          <circle cx="250" cy="250" r="240" fill="none" stroke="#ff6b6b" stroke-width="15"/>
        </svg>
      `,
      
      ornate: `
        <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
          <defs>
            <pattern id="pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
              <circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.3)"/>
            </pattern>
          </defs>
          <circle cx="250" cy="250" r="240" fill="none" stroke="#4a90e2" stroke-width="25"/>
          <circle cx="250" cy="250" r="240" fill="url(#pattern)" stroke="none"/>
          <circle cx="250" cy="250" r="215" fill="none" stroke="#fff" stroke-width="3"/>
          <circle cx="250" cy="250" r="265" fill="none" stroke="rgba(74,144,226,0.5)" stroke-width="2"/>
        </svg>
      `
    };
    
    // Khung m·∫∑c ƒë·ªãnh
    let currentFrame = 'gradient';
    
    // T·∫°o data URL t·ª´ SVG
    function getFrameDataURL(frameName) {
      return 'data:image/svg+xml;base64,' + btoa(FRAME_DESIGNS[frameName]);
    }
    
    // Load khung c·ªë ƒë·ªãnh khi trang load
    frameImg.src = getFrameDataURL(currentFrame);
    // Kh√¥ng c·∫ßn crossOrigin cho file local

    // Khung PNG trong su·ªët (thay link ·∫£nh PNG c·ªßa b·∫°n)
    // frameImg.src = "https://i.ibb.co/5RMRM2P/sample-frame.png";
    // frameImg.src = "https://drive.google.com/file/d/1oQHmE3C98oYSJhxtByJXoZyxE1SyIap7/view?usp=sharing"; 

    // Bi·∫øn ƒë·ªÉ ki·ªÉm so√°t hi·ªÉn th·ªã khung
    let showFrame = true;

    // H√†m thay ƒë·ªïi ki·ªÉu khung
    function changeFrame(frameName) {
      currentFrame = frameName;
      frameImg.src = getFrameDataURL(frameName);
    }

    // H√†m toggle khung
    function toggleFrame() {
      showFrame = !showFrame;
      const toggleBtn = document.getElementById('frameToggle');
      if (showFrame) {
        toggleBtn.innerHTML = '<span>üëÅÔ∏è</span><span>T·∫Øt khung</span>';
      } else {
        toggleBtn.innerHTML = '<span>üö´</span><span>B·∫≠t khung</span>';
      }
      draw();
    } 

    // Thi·∫øt l·∫≠p s·ª± ki·ªán onload cho frame c·ªë ƒë·ªãnh
    frameImg.onload = function() {
      frameImgLoaded = true;
      console.log('Fixed SVG frame loaded successfully');
      draw();
    };
    
    frameImg.onerror = function() {
      console.error('Failed to load inline SVG frame');
      frameImgLoaded = false;
      draw();
    };

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // V·∫Ω ·∫£nh avatar
      if (userImgLoaded && userImg.complete) {
        drawTransformedImage();
      }
      
      // V·∫Ω khung t·ª´ file (n·∫øu c√≥ v√† ƒëang b·∫≠t)
      if (frameImgLoaded && frameImg.complete && showFrame) {
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      }
    }

    function drawTransformedImage() {
      ctx.save();
      
      // Di chuy·ªÉn ƒë·∫øn center + offset
      const centerX = canvas.width / 2 + imgX;
      const centerY = canvas.height / 2 + imgY;
      ctx.translate(centerX, centerY);
      
      // Xoay
      ctx.rotate(imgRotation);
      
      // Scale
      ctx.scale(imgScale, imgScale);
      
      // V·∫Ω ·∫£nh v·ªõi center l√†m anchor point
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      ctx.drawImage(userImg, -imgWidth/2, -imgHeight/2, imgWidth, imgHeight);
      
      ctx.restore();
    }

    // Canvas mouse events for dragging
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('mousemove', drag);
    canvas.addEventListener('mouseup', endDrag);
    canvas.addEventListener('mouseleave', endDrag);

    // Canvas touch events for mobile
    canvas.addEventListener('touchstart', startTouchDrag, { passive: false });
    canvas.addEventListener('touchmove', touchDrag, { passive: false });
    canvas.addEventListener('touchend', endDrag);
    canvas.addEventListener('touchcancel', endDrag);

    // Slider events
    document.getElementById('scaleSlider').addEventListener('input', function(e) {
      imgScale = parseFloat(e.target.value);
      document.getElementById('scaleValue').textContent = Math.round(imgScale * 100) + '%';
      draw();
    });

    document.getElementById('rotationSlider').addEventListener('input', function(e) {
      imgRotation = parseFloat(e.target.value) * Math.PI / 180;
      document.getElementById('rotationValue').textContent = e.target.value + '¬∞';
      draw();
    });

    function resetTransform() {
      imgScale = 1;
      imgRotation = 0;
      imgX = 0;
      imgY = 0;
      document.getElementById('scaleSlider').value = 1;
      document.getElementById('rotationSlider').value = 0;
      document.getElementById('scaleValue').textContent = '100%';
      document.getElementById('rotationValue').textContent = '0¬∞';
      draw();
    }

    function startDrag(e) {
      if (!userImgLoaded) return;
      isDragging = true;
      const rect = canvas.getBoundingClientRect();
      lastMouseX = e.clientX - rect.left;
      lastMouseY = e.clientY - rect.top;
    }

    function drag(e) {
      if (!isDragging || !userImgLoaded) return;
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      imgX += mouseX - lastMouseX;
      imgY += mouseY - lastMouseY;
      
      lastMouseX = mouseX;
      lastMouseY = mouseY;
      
      draw();
    }

    function endDrag() {
      isDragging = false;
    }

    // Touch event handlers for mobile
    function startTouchDrag(e) {
      e.preventDefault(); // Prevent scrolling
      if (!userImgLoaded) return;
      isDragging = true;
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      lastMouseX = touch.clientX - rect.left;
      lastMouseY = touch.clientY - rect.top;
    }

    function touchDrag(e) {
      e.preventDefault(); // Prevent scrolling
      if (!isDragging || !userImgLoaded) return;
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      const touchX = touch.clientX - rect.left;
      const touchY = touch.clientY - rect.top;
      
      imgX += touchX - lastMouseX;
      imgY += touchY - lastMouseY;
      
      lastMouseX = touchX;
      lastMouseY = touchY;
      
      draw();
    }

    function downloadImage() {
      try {
        // Ph√°t hi·ªán thi·∫øt b·ªã mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const dataUrl = canvas.toDataURL("image/png");
        
        if (isMobile) {
          // Mobile: S·ª≠ d·ª•ng nhi·ªÅu ph∆∞∆°ng ph√°p ƒë·ªÉ l∆∞u ·∫£nh
          showMobileSaveOptions(dataUrl);
        } else {
          // Desktop: Download b√¨nh th∆∞·ªùng
          const link = document.createElement("a");
          link.download = "avatar_zalo_" + new Date().getTime() + ".png";
          link.href = dataUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        
      } catch (error) {
        if (error.name === 'SecurityError') {
          alert('‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh do h·∫°n ch·∫ø b·∫£o m·∫≠t.\n\nüí° H√£y ch·∫°y qua local server ho·∫∑c ch·ª•p m√†n h√¨nh.');
        } else {
          console.error('Download error:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i ·∫£nh.');
        }
      }
    }

    // Hi·ªÉn th·ªã t√πy ch·ªçn l∆∞u ·∫£nh cho mobile
    function showMobileSaveOptions(dataUrl) {
      // T·∫°o modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;

      // T·∫°o modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      `;

      const fileName = "avatar_zalo_" + new Date().getTime() + ".png";

      modal.innerHTML = `
        <h2 style="margin: 0 0 20px 0; color: #333;">üì± L∆∞u ·∫£nh avatar</h2>
        
        <img src="${dataUrl}" style="
          max-width: 100%; 
          height: auto; 
          border-radius: 15px; 
          margin: 20px 0;
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        ">
        
        <div style="
          background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
          padding: 20px;
          border-radius: 15px;
          margin: 20px 0;
          text-align: left;
        ">
          <h3 style="margin: 0 0 15px 0; text-align: center; color: #1565c0;">
            üéØ C√°ch l∆∞u ·∫£nh v√†o th∆∞ vi·ªán:
          </h3>
          
          <div style="
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
          ">
            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üì± iPhone/iPad:</h4>
            <p style="margin: 5px 0; line-height: 1.4;">
              ‚Ä¢ <strong>Nh·∫•n gi·ªØ ·∫£nh ph√≠a tr√™n</strong><br>
              ‚Ä¢ Ch·ªçn <strong>"L∆∞u v√†o ·∫¢nh"</strong><br>
              ‚Ä¢ ‚úÖ ·∫¢nh s·∫Ω c√≥ trong Th∆∞ vi·ªán ·∫£nh
            </p>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
          ">
            <h4 style="margin: 0 0 10px 0; color: #1565c0;">ü§ñ Android:</h4>
            <p style="margin: 5px 0; line-height: 1.4;">
              ‚Ä¢ <strong>Nh·∫•n gi·ªØ ·∫£nh ph√≠a tr√™n</strong><br>
              ‚Ä¢ Ch·ªçn <strong>"T·∫£i xu·ªëng"</strong> ho·∫∑c <strong>"L∆∞u ·∫£nh"</strong><br>
              ‚Ä¢ ‚úÖ ·∫¢nh s·∫Ω c√≥ trong Gallery/Downloads
            </p>
          </div>
        </div>
        
        <div style="margin: 25px 0;">
          <button onclick="downloadDirect('${dataUrl}', '${fileName}')" style="
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            min-width: 160px;
          ">
            üì• T·∫£i xu·ªëng tr·ª±c ti·∫øp
          </button>
          
          <button onclick="openImageInNewTab('${dataUrl}')" style="
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            min-width: 160px;
          ">
            üîó M·ªü tab m·ªõi
          </button>
          
          ${navigator.share ? `
          <button onclick="shareImage('${dataUrl}', '${fileName}')" style="
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            margin: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            min-width: 160px;
          ">
            üì§ Chia s·∫ª
          </button>
          ` : ''}
        </div>
        
        <button onclick="closeMobileModal()" style="
          background: #f44336;
          color: white;
          padding: 12px 20px;
          border: none;
          border-radius: 20px;
          font-size: 14px;
          cursor: pointer;
          margin-top: 15px;
        ">
          ‚ùå ƒê√≥ng
        </button>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // Global functions for modal buttons
      window.downloadDirect = function(dataUrl, fileName) {
        try {
          const link = document.createElement('a');
          link.href = dataUrl;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Show success message
          showSuccessMessage('‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i xu·ªëng! Ki·ªÉm tra th∆∞ m·ª•c Downloads.');
        } catch (error) {
          alert('‚ùå Kh√¥ng th·ªÉ t·∫£i xu·ªëng t·ª± ƒë·ªông. Vui l√≤ng nh·∫•n gi·ªØ ·∫£nh ph√≠a tr√™n.');
        }
      };

      window.openImageInNewTab = function(dataUrl) {
        const newWindow = window.open();
        newWindow.document.write(`
          <html>
            <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Avatar Image</title>
              <style>
                body { margin: 0; padding: 20px; text-align: center; background: #f5f5f5; }
                img { max-width: 100%; height: auto; border-radius: 15px; }
                .tip { 
                  background: #e3f2fd; 
                  padding: 15px; 
                  border-radius: 10px; 
                  margin: 20px; 
                  color: #1976d2; 
                }
              </style>
            </head>
            <body>
              <h2>üé® Avatar c·ªßa b·∫°n</h2>
              <img src="${dataUrl}" alt="Avatar">
              <div class="tip">
                üí° <strong>Nh·∫•n gi·ªØ ·∫£nh</strong> ƒë·ªÉ l∆∞u v√†o th∆∞ vi·ªán!
              </div>
            </body>
          </html>
        `);
        showSuccessMessage('üîó ƒê√£ m·ªü ·∫£nh trong tab m·ªõi! Nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ l∆∞u.');
      };

      window.shareImage = async function(dataUrl, fileName) {
        try {
          const response = await fetch(dataUrl);
          const blob = await response.blob();
          const file = new File([blob], fileName, { type: 'image/png' });
          
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: 'Avatar v·ªõi khung',
              text: '·∫¢nh avatar c·ªßa t√¥i',
              files: [file]
            });
            showSuccessMessage('üì§ ƒê√£ chia s·∫ª th√†nh c√¥ng!');
          } else {
            throw new Error('Cannot share files');
          }
        } catch (error) {
          console.log('Sharing failed:', error);
          alert('‚ùå Kh√¥ng th·ªÉ chia s·∫ª. Vui l√≤ng d√πng t·∫£i xu·ªëng tr·ª±c ti·∫øp.');
        }
      };

      window.closeMobileModal = function() {
        document.body.removeChild(overlay);
        // Clean up global functions
        delete window.downloadDirect;
        delete window.openImageInNewTab;
        delete window.shareImage;
        delete window.closeMobileModal;
        delete window.showSuccessMessage;
      };

      window.showSuccessMessage = function(message) {
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #4CAF50;
          color: white;
          padding: 15px 25px;
          border-radius: 25px;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          font-weight: 600;
        `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
          if (document.body.contains(successDiv)) {
            document.body.removeChild(successDiv);
          }
        }, 3000);
      };

      // Close modal when clicking overlay
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          window.closeMobileModal();
        }
      });
    }

    // Event listener cho upload avatar
    document.getElementById("upload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        userImg.onload = function() {
          userImgLoaded = true;
          // Reset transform when loading new image
          resetTransform();
        };
        // Use data URL from FileReader to avoid CORS issues
        userImg.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Event listener cho ch·ªçn ki·ªÉu khung
    document.getElementById("frameSelect").addEventListener("change", function(e) {
      changeFrame(e.target.value);
    });
  </script>
</body>
</html>
