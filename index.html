<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Gh√©p khung avatar</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        <!-- Controls Section -->
        <div class="section">
          <h3>üéõÔ∏è ƒêi·ªÅu ch·ªânh ·∫£nh</h3>
          <div class="controls">
            <div class="control-group">
              <label>üñºÔ∏è Ki·ªÉu khung</label>
              <div class="control-row">
                <select id="frameSelect" class="slider" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                  <option value="gradient">Gradient nhi·ªÅu m√†u</option>
                  <option value="simple">ƒê∆°n gi·∫£n</option>
                  <option value="ornate">Trang tr√≠</option>
                </select>
              </div>
            </div>
            
            <div class="control-group">
              <label>üëÅÔ∏è Hi·ªÉn th·ªã khung</label>
              <button onclick="toggleFrame()" class="btn btn-secondary" id="frameToggle">
                <span>üëÅÔ∏è</span>
                <span>T·∫Øt khung</span>
              </button>
            </div>
            
            <div class="control-group">
              <label>üîç K√≠ch th∆∞·ªõc</label>0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 300;
    }
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .right-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      border: 1px solid #e9ecef;
    }
    .section h3 {
      margin: 0 0 20px 0;
      font-size: 1.3rem;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    canvas { 
      border: 3px solid #dee2e6; 
      border-radius: 15px;
      cursor: grab; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    canvas:active { cursor: grabbing; }
    .frame-gallery { 
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .frame-option { 
      width: 80px; 
      height: 80px; 
      border: 3px solid #dee2e6; 
      cursor: pointer; 
      border-radius: 12px;
      transition: all 0.3s ease;
      justify-self: center;
    }
    .frame-option:hover { 
      border-color: #667eea; 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .frame-option.selected { 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      transform: scale(1.05);
    }
    .upload-section {
      text-align: center;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .file-button:hover {
      transform: translateY(-2px);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #dee2e6;
      outline: none;
      appearance: none;
    }
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }
    .value-display {
      min-width: 60px;
      text-align: center;
      font-weight: 600;
      color: #667eea;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-secondary {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .help-text {
      background: #e3f2fd;
      color: #1976d2;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      border-left: 4px solid #2196f3;
    }
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      .frame-gallery {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé® Gh√©p khung avatar</h1>
    </div>
    
    <div class="main-content">
      <!-- Left Panel - Controls -->
      <div class="left-panel">
        <!-- Upload Avatar Section -->
        <div class="section upload-section">
          <h3>üì∏ Ch·ªçn ·∫£nh avatar</h3>
          <div class="file-input-wrapper">
            <input type="file" id="upload" class="file-input" accept="image/*">
            <button class="file-button">
              <span>üìÅ</span>
              <span>T·∫£i ·∫£nh l√™n</span>
            </button>
          </div>
        </div>

        <!-- Controls Section -->
        <div class="section">
          <h3>üéõÔ∏è ƒêi·ªÅu ch·ªânh ·∫£nh</h3>
          <div class="controls">
            <div class="control-group">
              <label>ÔøΩÔ∏è Khung</label>
              <button onclick="toggleFrame()" class="btn btn-secondary" id="frameToggle">
                <span>üëÅÔ∏è</span>
                <span>T·∫Øt khung</span>
              </button>
            </div>
            
            <div class="control-group">
              <label>ÔøΩüîç K√≠ch th∆∞·ªõc</label>
              <div class="control-row">
                <input type="range" id="scaleSlider" class="slider" min="0.5" max="3" step="0.1" value="1">
                <span id="scaleValue" class="value-display">100%</span>
              </div>
            </div>
            
            <div class="control-group">
              <label>‚ÜîÔ∏è Xoay</label>
              <div class="control-row">
                <input type="range" id="rotationSlider" class="slider" min="-180" max="180" step="5" value="0">
                <span id="rotationValue" class="value-display">0¬∞</span>
              </div>
            </div>
            
            <button onclick="resetTransform()" class="btn btn-secondary">
              <span>üîÑ</span>
              <span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Right Panel - Canvas and Actions -->
      <div class="right-panel">
        <canvas id="canvas" width="500" height="500"></canvas>
        
        <div class="help-text">
          üí° K√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn, d√πng thanh tr∆∞·ª£t ƒë·ªÉ thay ƒë·ªïi k√≠ch th∆∞·ªõc v√† xoay
        </div>
        
        <div class="button-group">
          <button onclick="downloadImage()" class="btn btn-primary">
            <span>‚¨áÔ∏è</span>
            <span>T·∫£i ·∫£nh k·∫øt qu·∫£</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let userImg = new Image();
    let frameImg = new Image();
    let userImgLoaded = false;
    let frameImgLoaded = false;
    
    // Set crossOrigin to avoid tainted canvas issues
    userImg.crossOrigin = "anonymous";
    frameImg.crossOrigin = "anonymous";

    // Transform properties
    let imgScale = 1;
    let imgRotation = 0;
    let imgX = 0;
    let imgY = 0;
    let isDragging = false;
    let lastMouseX = 0;
    let lastMouseY = 0;

    // C√°c khung c·ªë ƒë·ªãnh - s·ª≠ d·ª•ng SVG inline ƒë·ªÉ tr√°nh CORS
    const FRAME_DESIGNS = {
      gradient: `
        <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
          <defs>
            <linearGradient id="frameGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#ffa500;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ff1493;stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle cx="250" cy="250" r="240" fill="none" stroke="url(#frameGradient)" stroke-width="20"/>
          <circle cx="250" cy="250" r="220" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2"/>
          <circle cx="250" cy="250" r="260" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
          <circle cx="250" cy="30" r="5" fill="#fff"/>
          <circle cx="470" cy="250" r="5" fill="#fff"/>
          <circle cx="250" cy="470" r="5" fill="#fff"/>
          <circle cx="30" cy="250" r="5" fill="#fff"/>
        </svg>
      `,
      
      simple: `
        <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
          <circle cx="250" cy="250" r="240" fill="none" stroke="#ff6b6b" stroke-width="15"/>
        </svg>
      `,
      
      ornate: `
        <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
          <defs>
            <pattern id="pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
              <circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.3)"/>
            </pattern>
          </defs>
          <circle cx="250" cy="250" r="240" fill="none" stroke="#4a90e2" stroke-width="25"/>
          <circle cx="250" cy="250" r="240" fill="url(#pattern)" stroke="none"/>
          <circle cx="250" cy="250" r="215" fill="none" stroke="#fff" stroke-width="3"/>
          <circle cx="250" cy="250" r="265" fill="none" stroke="rgba(74,144,226,0.5)" stroke-width="2"/>
        </svg>
      `
    };
    
    // Khung m·∫∑c ƒë·ªãnh
    let currentFrame = 'gradient';
    
    // T·∫°o data URL t·ª´ SVG
    function getFrameDataURL(frameName) {
      return 'data:image/svg+xml;base64,' + btoa(FRAME_DESIGNS[frameName]);
    }
    
    // Load khung c·ªë ƒë·ªãnh khi trang load
    frameImg.src = getFrameDataURL(currentFrame);
    // Kh√¥ng c·∫ßn crossOrigin cho file local

    // Khung PNG trong su·ªët (thay link ·∫£nh PNG c·ªßa b·∫°n)
    // frameImg.src = "https://i.ibb.co/5RMRM2P/sample-frame.png";
    // frameImg.src = "https://drive.google.com/file/d/1oQHmE3C98oYSJhxtByJXoZyxE1SyIap7/view?usp=sharing"; 

    // Bi·∫øn ƒë·ªÉ ki·ªÉm so√°t hi·ªÉn th·ªã khung
    let showFrame = true;

    // H√†m thay ƒë·ªïi ki·ªÉu khung
    function changeFrame(frameName) {
      currentFrame = frameName;
      frameImg.src = getFrameDataURL(frameName);
    }

    // H√†m toggle khung
    function toggleFrame() {
      showFrame = !showFrame;
      const toggleBtn = document.getElementById('frameToggle');
      if (showFrame) {
        toggleBtn.innerHTML = '<span>üëÅÔ∏è</span><span>T·∫Øt khung</span>';
      } else {
        toggleBtn.innerHTML = '<span>üö´</span><span>B·∫≠t khung</span>';
      }
      draw();
    } 

    // Thi·∫øt l·∫≠p s·ª± ki·ªán onload cho frame c·ªë ƒë·ªãnh
    frameImg.onload = function() {
      frameImgLoaded = true;
      console.log('Fixed SVG frame loaded successfully');
      draw();
    };
    
    frameImg.onerror = function() {
      console.error('Failed to load inline SVG frame');
      frameImgLoaded = false;
      draw();
    };

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // V·∫Ω ·∫£nh avatar
      if (userImgLoaded && userImg.complete) {
        drawTransformedImage();
      }
      
      // V·∫Ω khung t·ª´ file (n·∫øu c√≥ v√† ƒëang b·∫≠t)
      if (frameImgLoaded && frameImg.complete && showFrame) {
        ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      }
    }

    function drawTransformedImage() {
      ctx.save();
      
      // Di chuy·ªÉn ƒë·∫øn center + offset
      const centerX = canvas.width / 2 + imgX;
      const centerY = canvas.height / 2 + imgY;
      ctx.translate(centerX, centerY);
      
      // Xoay
      ctx.rotate(imgRotation);
      
      // Scale
      ctx.scale(imgScale, imgScale);
      
      // V·∫Ω ·∫£nh v·ªõi center l√†m anchor point
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      ctx.drawImage(userImg, -imgWidth/2, -imgHeight/2, imgWidth, imgHeight);
      
      ctx.restore();
    }

    // Canvas mouse events for dragging
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('mousemove', drag);
    canvas.addEventListener('mouseup', endDrag);
    canvas.addEventListener('mouseleave', endDrag);

    // Slider events
    document.getElementById('scaleSlider').addEventListener('input', function(e) {
      imgScale = parseFloat(e.target.value);
      document.getElementById('scaleValue').textContent = Math.round(imgScale * 100) + '%';
      draw();
    });

    document.getElementById('rotationSlider').addEventListener('input', function(e) {
      imgRotation = parseFloat(e.target.value) * Math.PI / 180;
      document.getElementById('rotationValue').textContent = e.target.value + '¬∞';
      draw();
    });

    function resetTransform() {
      imgScale = 1;
      imgRotation = 0;
      imgX = 0;
      imgY = 0;
      document.getElementById('scaleSlider').value = 1;
      document.getElementById('rotationSlider').value = 0;
      document.getElementById('scaleValue').textContent = '100%';
      document.getElementById('rotationValue').textContent = '0¬∞';
      draw();
    }

    function startDrag(e) {
      if (!userImgLoaded) return;
      isDragging = true;
      const rect = canvas.getBoundingClientRect();
      lastMouseX = e.clientX - rect.left;
      lastMouseY = e.clientY - rect.top;
    }

    function drag(e) {
      if (!isDragging || !userImgLoaded) return;
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      imgX += mouseX - lastMouseX;
      imgY += mouseY - lastMouseY;
      
      lastMouseX = mouseX;
      lastMouseY = mouseY;
      
      draw();
    }

    function endDrag() {
      isDragging = false;
    }

    function downloadImage() {
      try {
        const link = document.createElement("a");
        link.download = "avatar_zalo.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (error) {
        if (error.name === 'SecurityError') {
          alert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh xu·ªëng do h·∫°n ch·∫ø b·∫£o m·∫≠t c·ªßa tr√¨nh duy·ªát. ƒêi·ªÅu n√†y c√≥ th·ªÉ x·∫£y ra khi s·ª≠ d·ª•ng file local. Vui l√≤ng:\n\n1. Ch·∫°y trang web qua local server (Live Server extension)\n2. Ho·∫∑c ch·ª•p m√†n h√¨nh canvas ƒë·ªÉ l∆∞u ·∫£nh');
        } else {
          console.error('Download error:', error);
          alert('C√≥ l·ªói x·∫£y ra khi t·∫£i ·∫£nh xu·ªëng.');
        }
      }
    }

    // Event listener cho upload avatar
    document.getElementById("upload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        userImg.onload = function() {
          userImgLoaded = true;
          // Reset transform when loading new image
          resetTransform();
        };
        // Use data URL from FileReader to avoid CORS issues
        userImg.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Event listener cho ch·ªçn ki·ªÉu khung
    document.getElementById("frameSelect").addEventListener("change", function(e) {
      changeFrame(e.target.value);
    });
  </script>
</body>
</html>
